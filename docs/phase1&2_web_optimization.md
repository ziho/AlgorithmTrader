# AlgorithmTrader Phase 2: Web 管理界面 + 策略参数优化

> 开发规划文档 - 2026-02-01

---

## 📋 目录

- [项目背景](#项目背景)
- [一、Web 管理界面需求](#一web-管理界面需求)
- [二、策略参数优化模块需求](#二策略参数优化模块需求)
- [三、项目结构](#三项目结构)
- [四、开发顺序](#四开发顺序)
- [五、验收标准](#五验收标准)
- [六、注意事项](#六注意事项)

---

## 项目背景

AlgorithmTrader 是一个个人量化交易系统，已实现：

- ✅ 数据采集（OKX K线、资金费率）
- ✅ 回测引擎
- ✅ 5种内置策略
- ✅ 风控引擎
- ✅ 通知系统（Telegram/Bark/Webhook）
- ✅ Docker Compose 部署
- ✅ OKX 现货/永续 Adapter

现在需要开发：

1. **Web 管理界面** - 策略管理、系统监控、回测结果展示
2. **策略参数优化模块** - 多目标优化、防过拟合

---

## 一、Web 管理界面需求

### 1.1 用户场景

- 单用户，无需认证（内网使用）
- 全天候监控，但不会一直盯着
- 收到通知后查看问题
- 查看长时间回测结果
- 需要手机端支持（通过 VPN 访问内网）

### 1.2 与 Grafana 的分工

| 功能 | Web 管理界面 | Grafana |
|------|-------------|---------|
| 策略启停 | ✅ | ❌ |
| 参数配置 | ✅ | ❌ |
| 任务管理 | ✅ | ❌ |
| 系统状态 | ✅ 简要 | ✅ 详细 |
| 曲线图表 | ❌ | ✅ |
| K线可视化 | ❌ | ✅ |
| 指标仪表盘 | ❌ | ✅ |

**原则**: Web 界面专注"管理操作"，Grafana 专注"数据可视化"

### 1.3 功能模块

#### 页面 1: Dashboard（首页）

- 系统整体状态概览
- 各服务健康状态（collector/trader/scheduler）
- 当前运行中的策略数量
- 最近的告警/错误
- 最近完成的回测任务

#### 页面 2: 策略管理

- 策略列表（名称、状态、交易对、当前持仓、今日PnL）
- 策略启用/停用开关
- 策略参数查看与编辑（不编辑代码，只改参数值）
- 策略运行日志（最近 N 条）

#### 页面 3: 回测结果

- 回测历史列表（策略名、时间范围、关键指标）
- 回测详情查看（指标表格，链接到 Grafana 看图表）
- 回测结果对比（选择多个回测对比指标）

#### 页面 4: 参数优化

- 创建优化任务（选择策略、选择优化目标）
- 优化任务队列/进度
- 优化结果展示（Pareto 前沿、最优参数组合）
- 一键应用最优参数

#### 页面 5: 系统设置（可选）

- 查看当前配置
- 服务日志查看

### 1.4 技术要求

#### 前端

- 使用 Python 生态的 Web 框架（推荐 NiceGUI 或 FastAPI + HTMX）
- 原因：与现有 Python 代码无缝集成，开发快速
- 支持 WebSocket 实时更新
- 响应式设计，支持移动端

#### UI 设计

- 风格：Notion 简洁风格
- 配色：黑白灰主色调
- 支持亮色/暗色模式（跟随系统）
- 高信息密度，一屏展示多信息
- 无过多动画，简洁高效

#### 后端

- 集成到现有项目结构
- 新增 `services/web/` 目录
- 通过 API 与其他服务通信
- 状态持久化到 InfluxDB 或 SQLite

### 1.5 不需要的功能

- ❌ 用户认证/权限管理
- ❌ 手动下单/平仓
- ❌ 策略代码编辑
- ❌ 数据采集操作

---

## 二、策略参数优化模块需求

### 2.1 优化目标

多目标优化，同时考虑：

- 夏普比率（最大化）
- 卡尔马比率 / 收益回撤比（最大化）
- 最大回撤（最小化）
- 总收益（最大化）

### 2.2 优化方法

从简单开始，逐步扩展：

1. **Phase 1**: 网格搜索（Grid Search）
2. **Phase 2**: 随机搜索（Random Search）
3. **Phase 3**: 贝叶斯优化（可选，使用 Optuna）

### 2.3 参数定义机制

在策略类中声明可优化参数：

```python
class MyStrategy(StrategyBase):
    # 参数优化范围定义
    PARAM_SPACE = {
        "fast_period": {"type": "int", "min": 5, "max": 50, "step": 5},
        "slow_period": {"type": "int", "min": 20, "max": 100, "step": 10},
        "position_size": {"type": "float", "min": 0.1, "max": 1.0, "step": 0.1},
    }
```

### 2.4 防止过拟合

必须实现：

1. **样本内/样本外分割**（如 70%/30%）
2. **Walk-forward 分析**（滚动窗口验证）
3. **未来函数检测**（静态分析 + 运行时检查）

### 2.5 计算资源

- 硬件：i5-12代 / 64GB RAM / 12GB VRAM
- 使用多进程并行（ProcessPoolExecutor）
- 可接受长时间运行（一天）
- 后续可考虑 GPU 加速（如适用）

### 2.6 输出格式

- Pareto 前沿可视化
- 最优参数组合列表
- 各目标得分
- 样本内/样本外性能对比
- 保存结果到文件（JSON/Parquet）

---

## 三、项目结构

```
AlgorithmTrader/
├── src/
│   ├── optimization/              # 新增：参数优化模块
│   │   ├── __init__.py
│   │   ├── engine.py              # 优化引擎主类
│   │   ├── objectives.py          # 目标函数定义
│   │   ├── search/                # 搜索算法
│   │   │   ├── __init__.py
│   │   │   ├── grid.py            # 网格搜索
│   │   │   ├── random.py          # 随机搜索
│   │   │   └── bayesian.py        # 贝叶斯优化 (可选)
│   │   ├── validation.py          # 验证方法 (walk-forward)
│   │   └── future_leak.py         # 未来函数检测
│   └── ...
├── services/
│   ├── web/                       # 新增：Web 管理服务
│   │   ├── __init__.py
│   │   ├── main.py                # 服务入口
│   │   ├── api/                   # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── strategies.py      # 策略管理 API
│   │   │   ├── backtests.py       # 回测结果 API
│   │   │   ├── optimization.py    # 优化任务 API
│   │   │   └── system.py          # 系统状态 API
│   │   ├── pages/                 # 页面组件
│   │   │   ├── __init__.py
│   │   │   ├── dashboard.py       # 首页
│   │   │   ├── strategies.py      # 策略管理页
│   │   │   ├── backtests.py       # 回测结果页
│   │   │   └── optimization.py    # 参数优化页
│   │   ├── components/            # 可复用组件
│   │   │   ├── __init__.py
│   │   │   ├── status_card.py
│   │   │   ├── strategy_table.py
│   │   │   └── param_editor.py
│   │   └── static/                # 静态资源 (如需要)
│   └── ...
├── tests/
│   ├── unit/
│   │   ├── test_optimization_engine.py
│   │   ├── test_grid_search.py
│   │   ├── test_walk_forward.py
│   │   └── test_future_leak.py
│   └── integration/
│       └── test_web_api.py
└── ...
```

---

## 四、开发顺序

### Phase 1: 基础框架 (1-2天)

1. 搭建 Web 服务框架（选择 NiceGUI 或 FastAPI+HTMX）
2. 实现 Dashboard 页面骨架
3. 实现系统状态 API

### Phase 2: 策略管理 (2-3天)

4. 策略列表展示
5. 策略启用/停用功能
6. 策略参数配置界面
7. 实时状态更新（WebSocket）

### Phase 3: 回测展示 (1-2天)

8. 回测历史列表
9. 回测详情展示
10. 多回测对比功能

### Phase 4: 优化模块核心 (3-5天)

11. 优化引擎框架
12. 网格搜索实现
13. 多目标评估（Pareto 前沿）
14. 样本分割 + Walk-forward 验证
15. 未来函数检测

### Phase 5: 优化界面 (2-3天)

16. 优化任务创建界面
17. 任务进度展示
18. 优化结果展示
19. 一键应用最优参数

### Phase 6: 完善 (1-2天)

20. 移动端适配
21. 暗色模式
22. 性能优化
23. 文档补充

---

## 五、验收标准

### Web 界面

- [ ] 所有页面可正常访问
- [ ] 策略启停功能正常工作
- [ ] 参数修改能正确持久化
- [ ] WebSocket 实时更新正常
- [ ] 手机端可正常使用
- [ ] 支持亮色/暗色模式

### 参数优化

- [ ] 能对任意带 PARAM_SPACE 的策略进行优化
- [ ] 网格搜索正常工作
- [ ] 输出 Pareto 前沿结果
- [ ] Walk-forward 验证正常
- [ ] 未来函数检测能捕获常见错误
- [ ] 结果可保存和加载
- [ ] 多进程并行加速生效

### 代码质量

- [ ] 通过所有单元测试
- [ ] 通过 ruff 检查
- [ ] 有适当的文档注释
- [ ] 新增测试覆盖率 > 80%

---

## 六、注意事项

### UI 设计

1. Web 界面不要与 Grafana 功能重复
2. Grafana 负责数据可视化（曲线图、K线图等）
3. Web 界面专注于"管理操作"和"状态展示"
4. 保持 Notion 简洁风格，黑白灰配色
5. 优先保证功能可用，后续再优化 UI 细节

### 参数优化

1. 参数范围必须在策略代码中定义，Web 不可修改
2. 防过拟合是核心关注点
3. 支持中断和恢复长时间运行的优化任务
4. 优化结果需要清晰展示样本内/样本外性能差异

### 技术选型建议

**推荐方案 A: NiceGUI**
- 优点：纯 Python，组件丰富，实时更新内置，开发快
- 缺点：相对新，社区较小

**备选方案 B: FastAPI + HTMX + TailwindCSS**
- 优点：更灵活，社区大，可定制性强
- 缺点：需要更多前端代码

### 硬件说明

当前配置 (i5-12代 / 64GB RAM / 12GB VRAM) 对于：
- 网格搜索：足够，使用多进程并行
- 贝叶斯优化：足够
- GPU 加速：如回测涉及大量数值计算可考虑，但非必须

---

## 附录：开发 Prompt

开始新对话时，可使用以下 Prompt：

```
我正在开发 AlgorithmTrader 项目的 Phase 2 功能：

1. Web 管理界面 - 策略管理、系统监控、回测结果展示
2. 策略参数优化模块 - 多目标优化、防过拟合

详细需求请查看 docs/phase2_web_optimization.md

请按照文档中的开发顺序，从 Phase 1 基础框架开始实现。
技术选型倾向于使用 NiceGUI（或你认为更合适的 Python Web 框架）。
UI 风格参考 Notion，配色黑白灰，支持亮色/暗色模式。

现在开始 Phase 1：搭建 Web 服务框架。
```

---

*文档创建日期: 2026-02-01*

# =============================================================================
# 监控配置
# 定义系统监控、健康检查和性能指标
# =============================================================================

# 全局监控设置
global:
  # 监控开关
  enabled: true
  
  # 监控频率(秒)
  check_interval: 60
  
  # 数据保留期(天)
  retention_days: 30
  
  # 时区设置
  timezone: "UTC"

# 系统健康监控
system_health:
  # CPU监控
  cpu:
    warning_threshold: 70     # CPU使用率预警阈值(%)
    critical_threshold: 85    # CPU使用率严重阈值(%)
    check_interval: 30        # 检查间隔(秒)
    
  # 内存监控
  memory:
    warning_threshold: 75     # 内存使用率预警阈值(%)
    critical_threshold: 90    # 内存使用率严重阈值(%)
    check_interval: 30
    
  # 磁盘监控
  disk:
    warning_threshold: 80     # 磁盘使用率预警阈值(%)
    critical_threshold: 90    # 磁盘使用率严重阈值(%)
    check_interval: 300       # 检查间隔(秒)
    
  # 网络监控
  network:
    max_latency: 100          # 最大网络延迟(毫秒)
    packet_loss_threshold: 1  # 丢包率阈值(%)
    check_interval: 60

# 服务健康监控
service_health:
  # InfluxDB监控
  influxdb:
    check_interval: 60
    timeout: 10               # 连接超时(秒)
    max_response_time: 2000   # 最大响应时间(毫秒)
    
    # 健康检查查询
    health_query: |
      from(bucket: "marketdata")
      |> range(start: -5m)
      |> filter(fn: (r) => r._measurement == "crypto_ohlcv_1m")
      |> count()
      
  # Redis监控
  redis:
    check_interval: 60
    timeout: 5
    max_response_time: 100    # 最大响应时间(毫秒)
    max_memory_usage: 1000    # 最大内存使用(MB)
    
  # PostgreSQL监控
  postgres:
    check_interval: 60
    timeout: 10
    max_response_time: 1000
    max_connections: 50       # 最大连接数
    
  # Grafana监控
  grafana:
    check_interval: 300
    timeout: 10
    expected_status_code: 200

# 数据质量监控
data_quality:
  # 数据新鲜度监控
  freshness:
    check_interval: 300       # 检查间隔(秒)
    max_age_minutes: 60       # 数据最大延迟(分钟)
    critical_age_minutes: 120 # 严重延迟阈值
    
  # 数据完整性监控
  completeness:
    check_interval: 3600      # 检查间隔(秒)
    expected_data_points_per_hour: 60  # 每小时期望数据点数
    missing_data_threshold: 5          # 缺失数据阈值(%)
    
  # 数据一致性监控
  consistency:
    check_interval: 3600
    price_volatility_threshold: 0.1    # 价格波动阈值
    volume_spike_threshold: 5.0        # 成交量异常阈值
    
  # 数据准确性监控
  accuracy:
    cross_validation: true             # 交叉验证
    outlier_detection: true            # 异常值检测
    price_range_check: true            # 价格范围检查

# 应用性能监控
application_performance:
  # 数据采集器监控
  data_collector:
    check_interval: 300
    metrics:
      - download_speed          # 下载速度 (records/sec)
      - processing_latency      # 处理延迟 (ms)
      - error_rate             # 错误率 (%)
      - queue_size             # 队列大小
      
  # 策略引擎监控
  strategy_engine:
    check_interval: 60
    metrics:
      - signal_generation_time  # 信号生成时间 (ms)
      - backtest_duration      # 回测耗时 (seconds)
      - memory_usage           # 内存使用 (MB)
      - active_strategies      # 活跃策略数
      
  # 风险引擎监控
  risk_engine:
    check_interval: 30
    metrics:
      - risk_check_time        # 风险检查时间 (ms)
      - alerts_generated       # 生成的告警数
      - rules_evaluated        # 评估的规则数
      - blocked_trades         # 被阻止的交易数

# 业务指标监控
business_metrics:
  # 交易指标
  trading_metrics:
    check_interval: 300
    metrics:
      - total_trades           # 总交易数
      - successful_trades      # 成功交易数
      - failed_trades          # 失败交易数
      - average_execution_time # 平均执行时间
      - slippage_average       # 平均滑点
      
  # 财务指标
  financial_metrics:
    check_interval: 3600
    metrics:
      - portfolio_value        # 组合价值
      - realized_pnl          # 已实现盈亏
      - unrealized_pnl        # 未实现盈亏
      - drawdown_current      # 当前回撤
      - sharpe_ratio          # 夏普比率
      
  # 风险指标
  risk_metrics:
    check_interval: 1800
    metrics:
      - var_daily             # 日VaR
      - risk_score            # 风险评分
      - position_concentration # 仓位集中度
      - leverage_ratio        # 杠杆比率

# 外部依赖监控
external_dependencies:
  # Binance API监控
  binance_api:
    check_interval: 300
    endpoints:
      - url: "https://api.binance.com/api/v3/ping"
        timeout: 5
        expected_status: 200
      - url: "https://api.binance.com/api/v3/time"
        timeout: 5
        max_time_diff: 1000   # 最大时间差(毫秒)
        
  # 数据源监控
  data_sources:
    binance_data:
      check_interval: 1800
      url: "https://data.binance.vision/"
      timeout: 10
      
# 日志监控
log_monitoring:
  # 错误日志监控
  error_logs:
    check_interval: 300
    patterns:
      - pattern: "ERROR"
        threshold: 10         # 5分钟内错误数阈值
        window: 300
      - pattern: "CRITICAL"
        threshold: 1
        window: 60
        
  # 性能日志监控
  performance_logs:
    check_interval: 600
    slow_query_threshold: 5000  # 慢查询阈值(毫秒)
    high_memory_threshold: 1000 # 高内存使用阈值(MB)

# 安全监控
security_monitoring:
  # 访问监控
  access_monitoring:
    check_interval: 300
    failed_login_threshold: 5   # 失败登录阈值
    unusual_access_detection: true
    
  # 异常行为检测
  anomaly_detection:
    enabled: true
    check_interval: 1800
    algorithms:
      - isolation_forest       # 孤立森林
      - statistical_outlier    # 统计异常值
      
# 容器监控
container_monitoring:
  # Docker容器监控
  docker:
    check_interval: 60
    metrics:
      - container_status       # 容器状态
      - restart_count         # 重启次数
      - cpu_usage_percent     # CPU使用率
      - memory_usage_bytes    # 内存使用量
      - network_io            # 网络IO
      - disk_io               # 磁盘IO
      
# 自动恢复
auto_recovery:
  # 服务自动重启
  service_restart:
    enabled: true
    max_restart_attempts: 3
    restart_delay: 30         # 重启延迟(秒)
    
  # 数据修复
  data_repair:
    enabled: true
    auto_fill_gaps: true      # 自动填补数据缺口
    backup_restore: false     # 自动从备份恢复
    
# 监控数据存储
monitoring_storage:
  # InfluxDB存储配置
  influxdb:
    bucket: "ops"
    retention_policy: "30d"
    
    # 测量名称
    measurements:
      system_metrics: "ops_system"
      service_health: "ops_service_health"
      data_quality: "ops_data_quality"
      application_performance: "ops_app_performance"
      business_metrics: "ops_business"
      
# 日志和输出
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # InfluxDB 指标字段
  metrics_fields:
    - "monitoring_checks_total"
    - "monitoring_errors_total"
    - "monitoring_duration_seconds"
    - "health_score_overall"
    - "services_healthy_count"
    - "services_unhealthy_count"
    - "data_quality_score"
    - "alerts_generated_total"
    - "auto_recovery_attempts"

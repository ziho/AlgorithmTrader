# =============================================================================
# å‘Šè­¦é…ç½®
# å®šä¹‰å‘Šè­¦è§„åˆ™ã€é€šçŸ¥æ¸ é“å’Œå¤„ç†ç­–ç•¥ï¼Œä½¿ç”¨ Bark è¿›è¡Œæ¶ˆæ¯æ¨é€
# =============================================================================

# å…¨å±€å‘Šè­¦è®¾ç½®
global:
  # å‘Šè­¦å¼€å…³
  enabled: true
  
  # å‘Šè­¦è¯„ä¼°é—´éš”(ç§’)
  evaluation_interval: 60
  
  # å‘Šè­¦æŠ‘åˆ¶æ—¶é—´(ç§’) - åŒç±»å‘Šè­¦çš„æœ€å°é—´éš”
  suppression_time: 300
  
  # æ—¶åŒºè®¾ç½®
  timezone: "UTC"

# Bark æ¨é€é…ç½®
bark:
  # Bark æœåŠ¡é…ç½®
  server:
    # Bark æœåŠ¡åœ°å€ (éœ€è¦åœ¨å®é™…éƒ¨ç½²æ—¶é…ç½®)
    base_url: "https://api.day.app"
    # æˆ–è‡ªå»ºæœåŠ¡å™¨: "http://your-bark-server.com"
    
  # æ¨é€å¯†é’¥ (éœ€è¦åœ¨å®é™…éƒ¨ç½²æ—¶é…ç½®çœŸå®å¯†é’¥)
  push_key: "4ud8K4qQADMvYHf9iYGRAo"
  
  # æ¨é€é…ç½®
  default_config:
    # æ¨é€å›¾æ ‡
    icon: "https://openmoji.org/data/color/svg/1F4B8.svg"
    
    # æ¨é€åˆ†ç»„
    group: "AlgorithmTrader"
    
    # æ¨é€å£°éŸ³
    sound: "default"
    
    # æ—¶æ•ˆæ€§é€šçŸ¥çº§åˆ«
    level: "active"  # active|timeSensitive|passive
    
  # ä¸åŒä¸¥é‡çº§åˆ«çš„æ¨é€é…ç½®
  severity_config:
    critical:
      sound: "alarm"
      level: "critical"  # å…³é”®å‘Šè­¦ï¼Œå¿½ç•¥å‹¿æ‰°æ¨¡å¼
      call: true         # æŒç»­å“é“ƒ30ç§’
    high:
      sound: "horn"
      level: "timeSensitive"  # æ—¶æ•ˆæ€§é€šçŸ¥
    medium:
      sound: "bell"
      level: "active"
    low:
      sound: "default"
      level: "passive"

# å‘Šè­¦è§„åˆ™å®šä¹‰
alert_rules:
  # ç³»ç»Ÿçº§å‘Šè­¦
  system_alerts:
    # CPUä½¿ç”¨ç‡å‘Šè­¦
    cpu_usage_high:
      condition: "cpu_usage_percent > 80"
      severity: "high"
      message: "CPUä½¿ç”¨ç‡è¿‡é«˜: {value}%"
      evaluation_period: 300    # æŒç»­æ—¶é—´(ç§’)
      recovery_threshold: 70    # æ¢å¤é˜ˆå€¼
      
    cpu_usage_critical:
      condition: "cpu_usage_percent > 90"
      severity: "critical"
      message: "CPUä½¿ç”¨ç‡ä¸¥é‡: {value}%"
      evaluation_period: 180
      recovery_threshold: 85
      
    # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
    memory_usage_high:
      condition: "memory_usage_percent > 85"
      severity: "high"
      message: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {value}%"
      evaluation_period: 300
      recovery_threshold: 75
      
    memory_usage_critical:
      condition: "memory_usage_percent > 95"
      severity: "critical"
      message: "å†…å­˜ä½¿ç”¨ç‡ä¸¥é‡: {value}%"
      evaluation_period: 120
      recovery_threshold: 90
      
    # ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
    disk_usage_high:
      condition: "disk_usage_percent > 85"
      severity: "medium"
      message: "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: {value}%"
      evaluation_period: 600
      recovery_threshold: 80
      
    disk_usage_critical:
      condition: "disk_usage_percent > 95"
      severity: "critical"
      message: "ç£ç›˜ç©ºé—´ä¸è¶³: {value}%"
      evaluation_period: 300
      recovery_threshold: 90

  # æœåŠ¡çº§å‘Šè­¦
  service_alerts:
    # InfluxDBæœåŠ¡å‘Šè­¦
    influxdb_down:
      condition: "influxdb_status != 'healthy'"
      severity: "critical"
      message: "InfluxDBæœåŠ¡å¼‚å¸¸: {error_message}"
      evaluation_period: 120
      
    influxdb_slow:
      condition: "influxdb_response_time > 5000"
      severity: "high"
      message: "InfluxDBå“åº”ç¼“æ…¢: {value}ms"
      evaluation_period: 300
      
    # RedisæœåŠ¡å‘Šè­¦
    redis_down:
      condition: "redis_status != 'healthy'"
      severity: "high"
      message: "RedisæœåŠ¡å¼‚å¸¸: {error_message}"
      evaluation_period: 180
      
    # PostgreSQLæœåŠ¡å‘Šè­¦
    postgres_down:
      condition: "postgres_status != 'healthy'"
      severity: "high"
      message: "PostgreSQLæœåŠ¡å¼‚å¸¸: {error_message}"
      evaluation_period: 180
      
    postgres_connections_high:
      condition: "postgres_active_connections > 40"
      severity: "medium"
      message: "PostgreSQLè¿æ¥æ•°è¿‡é«˜: {value}"
      evaluation_period: 600

  # æ•°æ®è´¨é‡å‘Šè­¦
  data_quality_alerts:
    # æ•°æ®å»¶è¿Ÿå‘Šè­¦
    data_stale:
      condition: "data_age_minutes > 60"
      severity: "high"
      message: "å¸‚åœºæ•°æ®å»¶è¿Ÿ: {value}åˆ†é’Ÿæœªæ›´æ–°"
      evaluation_period: 300
      
    data_very_stale:
      condition: "data_age_minutes > 180"
      severity: "critical"
      message: "å¸‚åœºæ•°æ®ä¸¥é‡å»¶è¿Ÿ: {value}åˆ†é’Ÿæœªæ›´æ–°"
      evaluation_period: 300
      
    # æ•°æ®ç¼ºå¤±å‘Šè­¦
    data_missing:
      condition: "missing_data_percent > 10"
      severity: "medium"
      message: "æ•°æ®ç¼ºå¤±ç‡è¿‡é«˜: {value}%"
      evaluation_period: 1800
      
    # æ•°æ®å¼‚å¸¸å‘Šè­¦
    data_anomaly:
      condition: "price_volatility > 0.2"
      severity: "medium"
      message: "{symbol}ä»·æ ¼å¼‚å¸¸æ³¢åŠ¨: {value}%"
      evaluation_period: 300

  # åº”ç”¨çº§å‘Šè­¦
  application_alerts:
    # ç­–ç•¥å¼•æ“å‘Šè­¦
    strategy_errors:
      condition: "strategy_error_rate > 0.05"
      severity: "high"
      message: "ç­–ç•¥å¼•æ“é”™è¯¯ç‡è¿‡é«˜: {value}%"
      evaluation_period: 600
      
    backtest_failed:
      condition: "backtest_status == 'failed'"
      severity: "medium"
      message: "å›æµ‹ä»»åŠ¡å¤±è´¥: {strategy_name}"
      evaluation_period: 0
      
    # æ•°æ®é‡‡é›†å‘Šè­¦
    collector_failed:
      condition: "collector_status == 'failed'"
      severity: "high"
      message: "æ•°æ®é‡‡é›†å™¨å¼‚å¸¸: {collector_name}"
      evaluation_period: 300
      
    download_slow:
      condition: "download_speed < 100"
      severity: "low"
      message: "æ•°æ®ä¸‹è½½é€Ÿåº¦ç¼“æ…¢: {value} records/sec"
      evaluation_period: 1800

  # ä¸šåŠ¡çº§å‘Šè­¦
  business_alerts:
    # äº¤æ˜“å‘Šè­¦
    execution_latency_high:
      condition: "execution_latency_ms > 1000"
      severity: "medium"
      message: "äº¤æ˜“æ‰§è¡Œå»¶è¿Ÿè¿‡é«˜: {value}ms"
      evaluation_period: 300
      
    # é£é™©å‘Šè­¦
    portfolio_drawdown_high:
      condition: "drawdown_percent > 10"
      severity: "high"
      message: "ç»„åˆå›æ’¤è¿‡é«˜: {value}%"
      evaluation_period: 300
      
    portfolio_drawdown_critical:
      condition: "drawdown_percent > 15"
      severity: "critical"
      message: "ç»„åˆå›æ’¤ä¸¥é‡: {value}%"
      evaluation_period: 180
      
    risk_score_high:
      condition: "risk_score > 0.8"
      severity: "medium"
      message: "é£é™©è¯„åˆ†è¿‡é«˜: {value}"
      evaluation_period: 600
      
    # èµ„é‡‘å‘Šè­¦
    capital_low:
      condition: "available_capital_ratio < 0.1"
      severity: "high"
      message: "å¯ç”¨èµ„é‡‘ä¸è¶³: {value}%"
      evaluation_period: 300

# å‘Šè­¦é€šçŸ¥ç­–ç•¥
notification_strategy:
  # é€šçŸ¥æ¸ é“ä¼˜å…ˆçº§
  channels:
    primary: "bark"
    backup: "log"
    
  # ä¸åŒä¸¥é‡çº§åˆ«çš„é€šçŸ¥ç­–ç•¥
  severity_routing:
    critical:
      channels: ["bark"]
      immediate: true
      max_frequency: "1/5m"     # æœ€å¤š5åˆ†é’Ÿä¸€æ¬¡
      escalation_time: 900      # 15åˆ†é’Ÿåå‡çº§
      
    high:
      channels: ["bark"]
      immediate: true
      max_frequency: "1/10m"
      escalation_time: 1800
      
    medium:
      channels: ["bark"]
      immediate: false
      batch_time: 300           # 5åˆ†é’Ÿæ‰¹é‡å‘é€
      max_frequency: "1/30m"
      
    low:
      channels: ["bark"]
      immediate: false
      batch_time: 1800          # 30åˆ†é’Ÿæ‰¹é‡å‘é€
      max_frequency: "1/2h"

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
suppression_rules:
  # ç›¸åŒå‘Šè­¦æŠ‘åˆ¶
  duplicate_suppression:
    enabled: true
    time_window: 300            # 5åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªå‘é€ä¸€æ¬¡
    
  # ä¾èµ–å…³ç³»æŠ‘åˆ¶
  dependency_suppression:
    enabled: true
    rules:
      # å¦‚æœInfluxDB downï¼Œåˆ™æŠ‘åˆ¶æ•°æ®ç›¸å…³å‘Šè­¦
      - parent: "influxdb_down"
        children: ["data_stale", "data_missing"]
        
      # å¦‚æœç³»ç»ŸCPUè¿‡é«˜ï¼Œåˆ™æŠ‘åˆ¶åº”ç”¨æ€§èƒ½å‘Šè­¦
      - parent: "cpu_usage_critical"
        children: ["strategy_errors", "download_slow"]

# å‘Šè­¦æ¢å¤é€šçŸ¥
recovery_notifications:
  enabled: true
  
  # æ¢å¤é€šçŸ¥ç­–ç•¥
  recovery_strategy:
    critical: true              # ä¸¥é‡å‘Šè­¦æ¢å¤æ—¶é€šçŸ¥
    high: true                  # é«˜çº§å‘Šè­¦æ¢å¤æ—¶é€šçŸ¥
    medium: false               # ä¸­çº§å‘Šè­¦æ¢å¤æ—¶ä¸é€šçŸ¥
    low: false                  # ä½çº§å‘Šè­¦æ¢å¤æ—¶ä¸é€šçŸ¥
    
  # æ¢å¤æ¶ˆæ¯æ¨¡æ¿
  recovery_message: "âœ… å‘Šè­¦æ¢å¤: {alert_name} - {recovery_time}"

# å‘Šè­¦å†å²å’Œç»Ÿè®¡
alert_history:
  # å†å²è®°å½•ä¿ç•™æœŸ(å¤©)
  retention_days: 90
  
  # ç»Ÿè®¡æŠ¥å‘Š
  statistics:
    enabled: true
    report_interval: "daily"    # daily|weekly|monthly
    
    # ç»Ÿè®¡æŒ‡æ ‡
    metrics:
      - total_alerts
      - alerts_by_severity
      - alerts_by_component
      - average_resolution_time
      - false_positive_rate

# æµ‹è¯•å’Œç»´æŠ¤
testing:
  # å‘Šè­¦æµ‹è¯•
  test_alerts:
    enabled: true
    test_schedule: "0 9 * * 1"  # æ¯å‘¨ä¸€9ç‚¹æµ‹è¯•
    test_message: "ğŸ§ª AlgorithmTraderå‘Šè­¦ç³»ç»Ÿæµ‹è¯•"
    
  # å¥åº·æ£€æŸ¥
  health_check:
    bark_connectivity: true     # æ£€æŸ¥Barkè¿é€šæ€§
    check_interval: 3600        # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡

# æ—¥å¿—å’Œç›‘æ§
logging:
  level: "INFO"
  
  # InfluxDB æŒ‡æ ‡å­—æ®µ
  metrics_fields:
    - "alerts_generated_total"
    - "alerts_sent_total"
    - "alerts_failed_total"
    - "alert_resolution_time_seconds"
    - "suppressed_alerts_total"
    - "bark_api_calls_total"
    - "bark_api_errors_total"
    - "notification_latency_ms"

# ç¤ºä¾‹Barkæ¶ˆæ¯æ ¼å¼
message_templates:
  default: |
    ğŸš¨ {severity_emoji} {alert_name}
    
    ğŸ“Š ç›‘æ§å¯¹è±¡: {component}
    ğŸ“ ä¸¥é‡çº§åˆ«: {severity}
    â° è§¦å‘æ—¶é—´: {trigger_time}
    ğŸ“ è¯¦ç»†ä¿¡æ¯: {message}
    
    ğŸ”— æŸ¥çœ‹è¯¦æƒ…: {dashboard_url}
    
    # ä¸¥é‡çº§åˆ«å¯¹åº”çš„emoji
    severity_emojis:
      critical: "ğŸ”´"
      high: "ğŸŸ " 
      medium: "ğŸŸ¡"
      low: "ğŸ”µ"
